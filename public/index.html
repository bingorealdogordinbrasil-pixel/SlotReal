<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SlotReal</title>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; text-align: center; margin: 0; }
        .top { background: #111; padding: 15px; display: flex; justify-content: space-around; border-bottom: 2px solid #d4af37; }
        .grid { display: grid; grid-template-columns: repeat(8, 5fr); gap: 5px; width: 320px; margin: 20px auto; }
        .cell { width: 35px; height: 35px; border-radius: 5px; font-size: 10px; display: flex; align-items: center; justify-content: center; }
        .bets { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; width: 320px; margin: auto; }
        .btn-b { background: #222; border: 1px solid #444; color: #fff; padding: 10px 0; border-radius: 5px; cursor: pointer; }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; color: #000; padding: 20px; border-radius: 10px; width: 260px; z-index: 100; }
        input { width: 90%; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>

    <div id="login-area" style="margin-top: 50px;">
        <input id="user" placeholder="Usuário"><br>
        <input id="pass" type="password" placeholder="Senha"><br>
        <button onclick="logar()" style="padding: 10px 50px; background: #d4af37; border: none; font-weight: bold;">ENTRAR</button>
    </div>

    <div id="game-area" style="display:none;">
        <div class="top">
            <span>Saldo: R$ <b id="saldo">0.00</b></span>
            <button onclick="document.getElementById('m-pix').style.display='block'" style="background: #009ee3; color: #fff; border: none; border-radius: 4px;">DEPOSITAR</button>
        </div>
        <h2 id="timer">02:00</h2>
        <div class="grid" id="grid"></div>
        <div class="bets" id="bet-btns"></div>
    </div>

    <div id="m-pix" class="modal">
        <h3>PIX Rápido</h3>
        <input type="number" id="v-pix" value="20">
        <button onclick="gerar()" style="width:100%; padding:10px; background:#d4af37; border:none; font-weight:bold;">GERAR QR CODE</button>
        <div id="res" style="display:none">
            <img id="img" style="width:150px; margin:10px 0;">
            <button onclick="copy()" style="width:100%; padding:10px; background:#000; color:#fff;">COPIAR CÓDIGO</button>
        </div>
        <button onclick="this.parentElement.style.display='none'" style="margin-top:10px; color:red; border:none; background:none;">FECHAR</button>
    </div>

<script>
    let st = { u: '', s: 0, b: [0,0,0,0,0,0,0,0,0,0], pix: '', idx: 0, lock: false };
    const CS = ['#FFF','#444','#FF0','#0F0','#F0F','#F00','#00F','#888','#808','#840'];
    const MP = [0,1,2,3,4,5,6,7,15,23,31,39,47,55,63,62,61,60,59,58,57,56,48,40,32,24,16,8];

    async function logar() {
        const r = await fetch('/auth/login', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ user: document.getElementById('user').value, pass: document.getElementById('pass').value })});
        const d = await r.json();
        if(d.success) { st.u = d.user; st.s = d.saldo; st.b = d.bets; init(); } else alert("Erro");
    }

    function init() {
        document.getElementById('login-area').style.display = 'none';
        document.getElementById('game-area').style.display = 'block';
        const g = document.getElementById('grid');
        for(let i=0; i<64; i++) {
            let c = document.createElement('div'); c.className = 'cell'; c.id = `c-${i}`;
            let p = MP.indexOf(i);
            if(p !== -1) { c.style.background = CS[p % 10]; c.innerText = 'R$ 5'; } else { c.style.opacity = '0.1'; }
            g.appendChild(c);
        }
        btns(); up(); setInterval(sync, 1000);
    }

    function btns() {
        const ba = document.getElementById('bet-btns'); ba.innerHTML = '';
        CS.forEach((c, i) => {
            let b = document.createElement('div'); b.className = 'btn-b'; b.style.borderBottom = `3px solid ${c}`;
            b.innerHTML = `COR ${i}<br><b id="vb-${i}">${st.b[i]}</b>`;
            b.onclick = async () => { 
                if(!st.lock && st.s >= 1) { 
                    st.b[i]++; st.s--; up(); 
                    await fetch('/api/save-saldo', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user:st.u, saldo:st.s, bets:st.b})});
                }
            };
            ba.appendChild(b);
        });
    }

    async function sync() {
        if(st.lock) return;
        const r = await fetch('/api/tempo-real'); const d = await r.json();
        document.getElementById('timer').innerText = `${Math.floor(d.segundos/60).toString().padStart(2,'0')}:${(d.segundos%60).toString().padStart(2,'0')}`;
        if(d.segundos === 0) spin();
    }

    async function spin() {
        st.lock = true;
        const r = await fetch('/api/spin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user:st.u})});
        const d = await r.json();
        let target = -1; for(let i=0; i<MP.length; i++) { if(i%10 === d.corAlvo) { target = i; break; } }
        let total = (MP.length * 2) + target, count = 0;
        const loop = () => {
            document.getElementById(`c-${MP[st.idx]}`).style.boxShadow = 'none';
            st.idx = (st.idx + 1) % MP.length;
            document.getElementById(`c-${MP[st.idx]}`).style.boxShadow = '0 0 15px #fff';
            count++;
            if(count < total) setTimeout(loop, 40);
            else { st.s = d.novoSaldo; st.b.fill(0); up(); st.lock = false; }
        };
        loop();
    }

    async function gerar() {
        const v = document.getElementById('v-pix').value;
        const r = await fetch('/gerar-pix', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userLogado:st.u, valor:v})});
        const d = await r.json();
        if(d.success) {
            document.getElementById('img').src = "data:image/png;base64," + d.imagem_qr;
            st.pix = d.copia_e_cola;
            document.getElementById('res').style.display = 'block';
        }
    }

    function up() { 
        document.getElementById('saldo').innerText = st.s.toFixed(2);
        st.b.forEach((v,i) => { if(document.getElementById(`vb-${i}`)) document.getElementById(`vb-${i}`).innerText = v; });
    }
    function copy() { navigator.clipboard.writeText(st.pix); alert("Copiado!"); }
</script>
</body>
</html>
