<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SlotReal - Oficial</title>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }
        #tela-login, #tela-jogo { width: 100%; display: flex; flex-direction: column; align-items: center; }
        .card { background: #111; padding: 20px; border-radius: 15px; border: 1px solid #d4af37; margin-top: 50px; width: 280px; text-align: center; }
        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: none; box-sizing: border-box; background: #222; color: #fff; outline: none; }
        .btn-g { background: #d4af37; border: none; padding: 15px; border-radius: 10px; font-weight: bold; width: 100%; cursor: pointer; color: #000; }
        
        .top-bar { width: 100%; background: #111; padding: 15px; display: flex; justify-content: space-around; border-bottom: 2px solid #d4af37; align-items: center; position: sticky; top: 0; z-index: 10; box-sizing: border-box; }
        .grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; background: #111; padding: 10px; border-radius: 10px; margin-top: 20px; }
        .cell { width: 38px; height: 38px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: bold; }
        .bet-area { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; width: 340px; margin-top: 15px; }
        .btn-bet { background: #222; padding: 10px 0; border-radius: 5px; cursor: pointer; font-size: 10px; border-bottom: 3px solid transparent; text-align: center; }
        
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; color: #000; padding: 20px; border-radius: 15px; z-index: 1000; width: 280px; text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        #res-pix img { width: 180px; height: 180px; margin: 10px auto; display: block; }
    </style>
</head>
<body>

    <div id="tela-login">
        <div class="card">
            <h2 style="color:#d4af37">LOGIN</h2>
            <input type="text" id="u" placeholder="Usuário">
            <input type="password" id="p" placeholder="Senha">
            <button class="btn-g" onclick="logar()">ENTRAR</button>
        </div>
    </div>

    <div id="tela-jogo" style="display:none">
        <div class="top-bar">
            <div>SALDO: R$ <span id="s-display" style="color:#2ecc71; font-weight:bold;">0.00</span></div>
            <div style="display: flex; gap: 8px;">
                <button onclick="abrirM('m-pix')" style="background:#009ee3; border:none; color:#fff; padding:8px 12px; border-radius:5px; font-weight:bold;">DEPÓSITO</button>
                <button onclick="abrirM('m-saque')" style="background:#e74c3c; border:none; color:#fff; padding:8px 12px; border-radius:5px; font-weight:bold;">SAQUE</button>
            </div>
        </div>
        <h1 id="timer" style="color:#d4af37">02:00</h1>
        <div class="grid" id="grid"></div>
        <div class="bet-area" id="bet-area"></div>
    </div>

    <div id="m-pix" class="modal">
        <h3 style="margin:0">Gerar PIX</h3>
        <input type="number" id="v-pix" value="20" style="background:#eee; color:#000; text-align:center;">
        <button class="btn-g" id="btn-pix" onclick="gerarPix()">GERAR AGORA</button>
        <div id="res-pix" style="display:none">
            <img id="q-img" src="">
            <button onclick="copiarPix()" style="background:#000; color:#fff; padding:10px; width:100%; border:none; border-radius:5px;">COPIAR CÓDIGO</button>
        </div>
        <button onclick="fecharM()" style="color:red; background:none; border:none; margin-top:10px; cursor:pointer;">FECHAR</button>
    </div>

    <div id="m-saque" class="modal">
        <h3 style="margin:0">Solicitar Saque</h3>
        <p style="font-size: 11px; color: #666;">O gerente irá avaliar e realizar o PIX.</p>
        <input type="text" id="ch-saque" placeholder="Chave PIX" style="background:#eee; color:#000;">
        <input type="number" id="v-saque" placeholder="Valor" style="background:#eee; color:#000;">
        <button class="btn-g" id="btn-saque" onclick="solicitarSaque()">SOLICITAR</button>
        <button onclick="fecharM()" style="color:red; background:none; border:none; margin-top:10px; cursor:pointer;">CANCELAR</button>
    </div>

<script>
    let bloqueado = false;
    let state = { u: '', s: 0, b: [0,0,0,0,0,0,0,0,0,0], idx: 0, pix_code: '' };
    const CORES = ['#FFF', '#444', '#FF0', '#0F0', '#F0F', '#F00', '#00F', '#888', '#808', '#840'];
    const MAP = [0,1,2,3,4,5,6,7,15,23,31,39,47,55,63,62,61,60,59,58,57,56,48,40,32,24,16,8];

    async function logar() {
        const u = document.getElementById('u').value.trim();
        const p = document.getElementById('p').value;
        const res = await fetch('/auth/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user:u, pass:p}) });
        const d = await res.json();
        if(d.success) { state.u = u; state.s = d.saldo; state.b = d.bets || state.b; iniciar(); } else alert("Erro no login");
    }

    function iniciar() {
        document.getElementById('tela-login').style.display = 'none';
        document.getElementById('tela-jogo').style.display = 'flex';
        const g = document.getElementById('grid'); g.innerHTML = '';
        for(let i=0; i<64; i++) {
            const c = document.createElement('div'); c.className = 'cell'; c.id = `c-${i}`;
            const pos = MAP.indexOf(i);
            if(pos !== -1) { c.style.background = CORES[pos % 10]; c.innerText = 'R$ 5'; }
            else { c.style.opacity = '0.05'; }
            g.appendChild(c);
        }
        botoes(); atualizar(); setInterval(sync, 1000);
    }

    function botoes() {
        const ba = document.getElementById('bet-area'); ba.innerHTML = '';
        CORES.forEach((c, i) => {
            const b = document.createElement('div'); b.className = 'btn-bet'; b.style.borderBottom = `3px solid ${c}`;
            b.innerHTML = `COR ${i}<br><b id="vb-${i}">${state.b[i]}</b>`;
            b.onclick = async () => {
                if(!bloqueado && state.s >= 1) {
                    state.b[i]++; state.s--; atualizar();
                    await fetch('/api/save-saldo', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user:state.u, saldo:state.s, bets:state.b})});
                }
            };
            ba.appendChild(b);
        });
    }

    async function sync() {
        if(bloqueado) return;
        const res = await fetch('/api/tempo-real'); const d = await res.json();
        document.getElementById('timer').innerText = `${Math.floor(d.segundos/60).toString().padStart(2,'0')}:${(d.segundos%60).toString().padStart(2,'0')}`;
        if(d.segundos === 0) rodar();
    }

    async function rodar() {
        bloqueado = true;
        const res = await fetch('/api/spin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user:state.u}) });
        const d = await res.json();
        let target = -1; for(let i=0; i<MAP.length; i++) { if(i%10 === d.corAlvo) { target = i; break; } }
        let total = (MAP.length * 2) + target, count = 0;
        const loop = () => {
            document.getElementById(`c-${MAP[state.idx]}`).style.boxShadow = 'none';
            state.idx = (state.idx + 1) % MAP.length;
            document.getElementById(`c-${MAP[state.idx]}`).style.boxShadow = '0 0 15px #fff';
            count++;
            if(count < total) setTimeout(loop, 40);
            else { state.s = d.novoSaldo; state.b.fill(0); atualizar(); bloqueado = false; }
        };
        loop();
    }

    async function gerarPix() {
        const v = document.getElementById('v-pix').value;
        const btn = document.getElementById('btn-pix');
        btn.innerText = "GERANDO..."; btn.disabled = true;
        try {
            const res = await fetch('/gerar-pix', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userLogado:state.u, valor:v}) });
            const d = await res.json();
            if(d.success) {
                document.getElementById('q-img').src = "data:image/png;base64," + d.imagem_qr;
                state.pix_code = d.copia_e_cola;
                document.getElementById('res-pix').style.display = 'block';
            } else { alert("Erro: " + d.message); }
        } catch(e) { alert("Erro de conexão"); }
        btn.innerText = "GERAR AGORA"; btn.disabled = false;
    }

    async function solicitarSaque() {
        const val = document.getElementById('v-saque').value;
        const chave = document.getElementById('ch-saque').value;
        if(!val || val > state.s) return alert("Saldo insuficiente ou valor inválido!");
        if(!chave) return alert("Informe a chave PIX!");

        const btn = document.getElementById('btn-saque');
        btn.innerText = "ENVIANDO..."; btn.disabled = true;

        const res = await fetch('/solicitar-saque', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ user: state.u, valor: val, chavePix: chave })
        });
        const d = await res.json();
        if(d.success) {
            state.s = d.novoSaldo;
            atualizar();
            alert("Pedido enviado ao gerente!");
            fecharM();
        } else { alert(d.message); }
        btn.innerText = "SOLICITAR"; btn.disabled = false;
    }

    function atualizar() {
        document.getElementById('s-display').innerText = state.s.toFixed(2);
        state.b.forEach((v,i) => { if(document.getElementById(`vb-${i}`)) document.getElementById(`vb-${i}`).innerText = v; });
    }
    function abrirM(id) { document.getElementById(id).style.display = 'block'; }
    function fecharM() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
    function copiarPix() { navigator.clipboard.writeText(state.pix_code); alert("Copiado!"); }
</script>
</body>
</html>
