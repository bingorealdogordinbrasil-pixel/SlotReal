<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SlotReal</title>
    <style>
        body { background: #050505; color: white; font-family: sans-serif; text-align: center; }
        #timer { font-size: 50px; color: #d4af37; margin: 20px; }
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; max-width: 500px; margin: auto; }
        .btn-cor { padding: 15px; border: 1px solid #333; background: #111; color: white; cursor: pointer; }
        .btn-cor.selected { border-color: #d4af37; background: #222; }
    </style>
</head>
<body>
    <h1>SlotReal</h1>
    <div id="saldo-box">Saldo: R$ <span id="saldo-display">0.00</span></div>
    <div id="timer">--:--</div>

    <div class="grid">
        <script>
            for(let i=0; i<10; i++) {
                document.write(`<div class="btn-cor" id="c-${i}" onclick="sel(${i})">COR ${i}<br><small id="v-${i}">R$ 0</small></div>`);
            }
        </script>
    </div>

    <div style="margin-top: 20px;">
        <input type="number" id="valor" placeholder="Valor R$" min="1">
        <button onclick="apostar()">APOSTAR</button>
    </div>

    <script>
        let user = localStorage.getItem('userSlot');
        let saldo = 0;
        let corSel = null;
        let apostas = [0,0,0,0,0,0,0,0,0,0];
        let rodando = false;

        async function carregar() {
            const res = await fetch('/auth/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user, pass: localStorage.getItem('passSlot') })
            });
            const d = await res.json();
            if(d.success) { saldo = d.saldo; document.getElementById('saldo-display').innerText = saldo.toFixed(2); }
        }
        carregar();

        function sel(i) { corSel = i; document.querySelectorAll('.btn-cor').forEach(b => b.classList.remove('selected')); document.getElementById('c-'+i).classList.add('selected'); }

        async function apostar() {
            let v = parseFloat(document.getElementById('valor').value);
            if(v < 1 || corSel === null || v > saldo) return alert("Verifique valor/saldo/cor!");
            saldo -= v;
            apostas[corSel] += v;
            document.getElementById('saldo-display').innerText = saldo.toFixed(2);
            document.getElementById('v-'+corSel).innerText = `R$ ${apostas[corSel]}`;
            await fetch('/api/save-saldo', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ user, saldo }) });
        }

        // --- RELÓGIO QUE NÃO RESETA NO F5 ---
        setInterval(async () => {
            const res = await fetch('/api/tempo-real');
            const data = await res.json();
            let s = data.segundos;
            let min = Math.floor(s / 60);
            let seg = s % 60;
            document.getElementById('timer').innerText = `${min.toString().padStart(2,'0')}:${seg.toString().padStart(2,'0')}`;
            
            if(s === 0 && !rodando) {
                rodando = true;
                const r = await fetch('/api/spin', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ user, bets: apostas }) });
                const d = await r.json();
                alert("Sorteado: Cor " + d.corAlvo);
                saldo = d.novoSaldo;
                document.getElementById('saldo-display').innerText = saldo.toFixed(2);
                apostas = [0,0,0,0,0,0,0,0,0,0];
                for(let i=0; i<10; i++) document.getElementById('v-'+i).innerText = `R$ 0`;
                setTimeout(() => { rodando = false; }, 2000);
            }
        }, 1000);
    </script>
</body>
</html>
